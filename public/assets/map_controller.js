function build_markers(returned_data,map,infowindow){b=eval(returned_data);for(var i=b.length-1;i>=0;--i){var lat=b[i][0]*100/decimals,lng=b[i][1]*100/decimals,id=b[i][2],icon="/icons/marker_bulb_combined.png",marker=new google.maps.Marker({position:new google.maps.LatLng(lat,lng),icon:icon,map:map,post_id:""+id});google.maps.event.addListener(marker,"click",function(){infoBubble2.setContent('<div class="phoneytext"></div>'),infoBubble2.open(map,this),url=$("#uri_current_area").html()+"/posts/"+this.post_id,$.ajax({url:url,cache:!1,success:function(returned_data){eval(returned_data),infoBubble2.setContent(html),infoBubble2.open()}})}),google.maps.event.addListener(map,"click",function(){infoBubble2.close()}),markersHash[id]=marker}var foot=new google.maps.MarkerImage("/icons/foot.png",new google.maps.Size(30,30),new google.maps.Point(0,0),new google.maps.Point(28,43)),plane=new google.maps.MarkerImage("/icons/plane.png",new google.maps.Size(30,30),new google.maps.Point(0,0),new google.maps.Point(28,43)),up=new google.maps.MarkerImage("/icons/up.png",new google.maps.Size(30,30),new google.maps.Point(0,0),new google.maps.Point(2,43)),down=new google.maps.MarkerImage("/icons/down.png",new google.maps.Size(30,30),new google.maps.Point(0,0),new google.maps.Point(2,43))}function processSVData(a,b){b==google.maps.StreetViewStatus.OK?(panorama.setVisible(!0),panorama.setPano(a.location.pano),panorama.setPov({heading:270,pitch:0,zoom:1})):panorama.setVisible(!1)}function zoomChanged(){map.getMapTypeId()=="roadmap"&&map.getZoom()<13?map.setMapTypeId("terrain"):map.getMapTypeId()=="terrain"&&map.getZoom()>=13&&map.setMapTypeId("roadmap")}function handleEnter(a,b){var c=b.keyCode?b.keyCode:b.which?b.which:b.charCode;c==13&&(geocode(),b.preventDefault())}function geocode(){var a=$("#issue_address_by_user").val();a!=""&&geocoder.geocode({address:a,partialmatch:!0,language:"en"},geocodeResult)}function geocodeResult(a,b){if(b=="OK"&&a.length>0){var c=a[0].geometry.viewport.getCenter();map.setZoom(11),map.fitBounds(a[0].geometry.viewport),map.setCenter(a[0].geometry.location),pos=a[0].geometry.location,marker.setPosition(pos),first&&(first=!1,marker.setVisible(!0)),codeLatLng(pos,map)}else alert("Address not found: "+b)}function round(a){return Math.round(a*decimals)/decimals}function codeLatLng(a,b){geocoder&&geocoder.geocode({latLng:a,language:"en"},function(c,d){var e=[];e.push("lat:"+r2(a.lat())),e.push("lng:"+r2(a.lng())),e.push("b:"+viewport_or_bound_to_string(b.getBounds())),e.push("z:"+b.getZoom());if(d==google.maps.GeocoderStatus.OK){var f=parse_results(c);f["country"]!=undefined&&e.push("c:"+remove_column_and_semi_column(f.country.name)),f[3]!=undefined&&e.push("3:"+f[3].name+"("+f[3].bounds+")"),f[4]!=undefined&&e.push("4:"+f[4].name+"("+f[4].bounds+")"),f[5]!=undefined&&e.push("5:"+f[5].name+"("+f[5].bounds+")"),f["postal_code"]!=undefined&&e.push("p:"+f.postal_code.name+"("+f.postal_code.bounds+")"),f["address"]!=undefined&&e.push("a:"+remove_column_and_semi_column(f.address.name)),$("#address_from_api").html(f.address.name)}else $("#address_from_api").html(original_text+" ("+d+")");$("#issue_api_data").val(e.join("; "))})}function remove_column_and_semi_column(a){return a}function search_country(a){for(var b=a.length-1;b>=0;b--)for(var c in a[b].types)if(a[b]["types"][c]!="political"&&a[b]["types"][c]=="country")return country_found=!0,a[b].long_name;return!1}function parse_results(a){var b=[];b.skipped=[];var c=/locality|administrative/;country_found=!1,level=3;for(var d=a.length-1;d>=0;d--)for(var e in a[d].types)if(a[d]["types"][e]!="political"){if(!country_found){var f=search_country(a[d].address_components);f&&(b.country=[],b.country.name=f)}a[d]["types"][e]=="postal_code"?(b.postal_code=[],b.postal_code.name=a[d].address_components[0].long_name,b.postal_code.bounds=return_bounds(a[d].geometry)):level<6&&a[d].types[e].match(c)?(b[level]=[],b[level].name=a[d].address_components[0].long_name,b[level].bounds=return_bounds(a[d].geometry),b[level].type=a[d].types[e],level++):d!=0&&b.skipped.push("Type: "+a[d].types[e]+" ("+a[d].formatted_address+")"),d==0&&(b.address=new Array,b.address.name=a[d].formatted_address,b.address.bounds=return_bounds(a[d].geometry),b.address.type=a[d].types[e])}return b}function simple_parse_results(a){var b="";for(var c in a)for(var d in a[c].types)if(a[c]["types"][d]!="political"){var e="";c==0&&(e=" ("+a[c].formatted_address+") "),b=b+c+" "+a[c].types[d]+": "+a[c].address_components[0].long_name+e+a[c].geometry.bounds+"\n"}return b}function xinspect_1(a){var b=parse_results(a),c=simple_parse_results(a),d="";return d=d+"length "+a.length+"\n",d=d+"\n\n\n"+xinspect(b)+"\n\n\n",d+=c,"START_INSPECT\n"+d+"END_INSPECT\n"}function return_bounds(a){return typeof a["viewport"]!=undefined?viewport_or_bound_to_string(a.viewport):typeof a["bounds"]!=undefined?viewport_or_bound_to_string(a.bounds):undefined}function viewport_or_bound_to_string(b){return a=b.toUrlValue().split(","),r2(a[0])+" "+r2(a[1])+" "+r2(a[2])+" "+r2(a[3])}function r2(a){return Math.round(a*decimals)}function xinspect(a,b){typeof b=="undefined"&&(b="");if(b.length>50)return"[MAX ITERATIONS]";var c=[],d="";for(var e in a){var f=typeof a[e];f=="object"?(c.push("\n"+b+'"'+e+'" ('+f+") =>"),c.push("\n"+xinspect(a[e],b+"    "))):c.push(b+'"'+e+'" ('+f+") => "+a[e])}return c.join("\n")}var geocoder,map,marker,first=!0,last_event,decimals=1e6,country_found=!1,original_text,markersHash=new Array;$(document).ready(function(){$.ajaxSetup({beforeSend:function(a){a.setRequestHeader("Accept","text/javascript")}}),$(".non_geo").hover(function(){$(this).removeClass().addClass("non_geo_hover")},function(){$(this).removeClass().addClass("non_geo")}),$(".geo").hover(function(){$(this).removeClass().addClass("geo_hover")},function(){$(this).removeClass().addClass("geo")}),$(".big_button").hover(function(){$(this).removeClass().addClass("big_button_hover")},function(){$(this).removeClass().addClass("big_button")}),a=$("#bounds").html().split(" "),show_bounds=!0,$("#bounds").html()=="-20000000 000000000 50000000 360000000"&&(show_bounds=!1),f=new google.maps.LatLng(parseFloat(a[0])/decimals,parseFloat(a[1])/decimals),e=new google.maps.LatLng(parseFloat(a[2])/decimals,parseFloat(a[3])/decimals);var b,c,d,e,f;b=new google.maps.LatLng(43.77,11.25),d=4,c=new google.maps.LatLngBounds(f,e);var g=[e,new google.maps.LatLng(e.lat(),f.lng()),f,new google.maps.LatLng(f.lat(),e.lng()),e],h=new google.maps.Polyline({path:g,strokeColor:"brown",strokeOpacity:.6,strokeWeight:1}),i={center:b,zoom:d,streetViewControl:!1,mapTypeControl:!0,panControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_TOP},scaleControl:!0,scaleControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map_canvas"),i),map.fitBounds(c),show_bounds&&h.setMap(map),google.maps.event.addListener(map,"zoom_changed",zoomChanged);var j=new google.maps.InfoWindow({content:"ciao"});infoBubble2=new InfoBubble({map:map,content:'<div class="phoneytext">Ciao</div>',shadowStyle:1,padding:0,backgroundColor:"rgb(57,57,57)",borderRadius:4,arrowSize:10,borderWidth:2,borderColor:"#2c2c2c",disableAutoPan:!0,hideCloseButton:!0,arrowPosition:30,backgroundClassName:"phoney",arrowStyle:2,minWidth:130,minHeight:104}),$.ajax({url:document.URL,cache:!1,success:function(a){build_markers(a,map,j)}})})